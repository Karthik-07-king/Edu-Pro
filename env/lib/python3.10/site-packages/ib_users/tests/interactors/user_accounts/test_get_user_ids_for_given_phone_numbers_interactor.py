import pytest

from unittest.mock import create_autospec, Mock
from ib_users.interactors.DTOs import common_dtos


class TestGetUserIdsForGivenPhoneNumbersInteractor:

    @pytest.fixture
    def account_storage(self):
        from ib_users.interactors.storages.user_accounts_storage import \
            UserAccountsStorage
        return create_autospec(UserAccountsStorage)

    @pytest.fixture
    def interactor(self, account_storage):
        from ib_users.interactors.user_accounts.get_user_ids_for_given_phone_numbers_interactor \
            import GetUserIdsForGivenPhoneNumbersInteractor
        return GetUserIdsForGivenPhoneNumbersInteractor(account_storage=account_storage)

    @pytest.fixture
    def phone_number_with_country_code_dtos(self):
        return [
            common_dtos.PhoneNumberDTO(
                phone_number="1234567890",
                country_code="91"),
            common_dtos.PhoneNumberDTO(
                phone_number="0987654321",
                country_code="91")
        ]

    @pytest.fixture
    def user_id_with_phone_number_dtos(self):
        from ib_users.interactors.storages.user_accounts_storage import UserIdWithPhoneNumberDTO
        return [
            UserIdWithPhoneNumberDTO(
                phone_number="1234567890",
                country_code="91",
                user_id="16fd2706-8baf-433b-82eb-8c7fada847da")
        ]

    def test_with_given_phone_numbers_returns_user_ids(
            self, interactor, account_storage,
            phone_number_with_country_code_dtos,
            user_id_with_phone_number_dtos):
        # Arrange
        account_storage.get_user_ids_for_given_phone_numbers.return_value = \
            user_id_with_phone_number_dtos

        # Act
        actual_user_ids_for_given_phone_numbers = interactor.get_user_ids_for_given_phone_numbers(
            phone_number_with_country_code_dtos=phone_number_with_country_code_dtos)

        # Assert
        assert actual_user_ids_for_given_phone_numbers == user_id_with_phone_number_dtos
        account_storage.get_user_ids_for_given_phone_numbers.assert_called_once_with(
            phone_number_with_country_code_dtos=phone_number_with_country_code_dtos)
