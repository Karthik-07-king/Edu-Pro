import pytest

from ib_users.interfaces import enums
from ib_users.tests.factories import interface_dtos, models


pytestmark = pytest.mark.django_db


class TestCreateOrUpdateUserGuardianDetailsInteractor:

    @pytest.fixture()
    def interactor(self):
        from ib_users.storages.user_profile_sql_storage import UserProfileSQLStorage
        from ib_users.storages import UserAccountsSQLStorage
        from ib_users.interactors.user_profile.\
            create_or_update_user_guardian_details_interactor import \
            CreateOrUpdateUserGuardianDetailsInteractor

        return CreateOrUpdateUserGuardianDetailsInteractor(
            user_profile_storage=UserProfileSQLStorage(),
            user_account_storage=UserAccountsSQLStorage())

    def test_given_user_have_no_guardian_details_then_create_guardian_details(
            self, interactor):
        # Arrange
        user_id = "5fd64953-7c9a-4e34-9f46-d9ad554dfe81"
        models.UserAccountFactory(user_id=user_id)
        user_guardian_details = interface_dtos.UserGuardianDetailsDTOFactory(
            user_id=user_id,
            first_name="first_name",
            last_name="last_name",
            relation=enums.GuardianRelation.FATHER.value,
            other_relation="other_relation",
            job_role_id="job_role_id",
            job_role_name="job_role_name",
            other_job_role_name="other_job_role_name",
            email="john@gamil.com",
            country_code="91",
            phone_number="9988776655",
            have_whatsapp=True,
            whatsapp_mobile_country_code="91",
            whatsapp_mobile_number="9988776655")

        # Act
        interactor.create_or_update_user_guardian_details(
            user_guardian_details=user_guardian_details)

        # Assert
        from ib_users.models import UserGuardianDetails
        obj = UserGuardianDetails.objects.get(
            user_account__user_id=user_id)
        assert obj.first_name == user_guardian_details.first_name
        assert obj.last_name == user_guardian_details.last_name
        assert obj.relation == user_guardian_details.relation
        assert obj.job_role_id == user_guardian_details.job_role_id
        assert obj.job_role_name == user_guardian_details.job_role_name
        assert obj.other_job_role_name == user_guardian_details.other_job_role_name
        assert obj.email == user_guardian_details.email
        assert obj.phone_number == user_guardian_details.phone_number
        assert obj.country_code == user_guardian_details.country_code
        assert obj.have_whatsapp == user_guardian_details.have_whatsapp
        assert obj.whatsapp_mobile_number == user_guardian_details.whatsapp_mobile_number
        assert obj.whatsapp_mobile_country_code == user_guardian_details.whatsapp_mobile_country_code
        assert obj.other_relation == user_guardian_details.other_relation
