import typing

from ib_users.interactors.DTOs import common_dtos as interactor_dtos
from ib_users.interactors.storages.user_accounts_storage import UserAccountsStorage


class GetUserIdsForGivenPhoneNumbersInteractor:

    def __init__(self, account_storage: UserAccountsStorage):
        self.account_storage = account_storage

    def get_user_ids_for_given_phone_numbers(
            self, phone_number_with_country_code_dtos:
            typing.List[interactor_dtos.PhoneNumberDTO]):
        from ib_users.utils.divide_input_data_into_batches import divide_input_data_into_batches

        batch_wise_phone_numbers = divide_input_data_into_batches(
            input_data_list=phone_number_with_country_code_dtos, batch_size=500)
        user_ids_with_phone_number_dtos = []

        for batch_wise_phone_number_dtos in batch_wise_phone_numbers:
            user_ids_with_phone_number_dtos.extend(
                self.account_storage.get_user_ids_for_given_phone_numbers(
                    phone_number_with_country_code_dtos=batch_wise_phone_number_dtos)
            )
        return user_ids_with_phone_number_dtos
