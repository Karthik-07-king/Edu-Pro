from ib_users.interactors.storages import UserAccountsStorage
from ib_users.interactors.third_party.otp_service import OTPService
from ib_users.interactors.user_credentials.DTOs.user_credentials_dtos import \
    UserResetPasswordOtpEmailDTO
from ib_users.validators import EmailValidator, PasswordValidator


class VerifyResetPasswordOTPToEmailInteractor:
    def __init__(
            self, storage: UserAccountsStorage, otp_service: OTPService):
        self.storage = storage
        self.otp_service = otp_service

    def reset_password_with_otp_email(
            self, reset_password_dto: UserResetPasswordOtpEmailDTO):
        PasswordValidator.validate(reset_password_dto.new_password)
        self.otp_service.validate_otp_send_to_recovery_email(
            email=reset_password_dto.email,
            otp=reset_password_dto.otp,
            user_id=reset_password_dto.user_id
        )
        self.storage.update_user_password(
            user_id=reset_password_dto.user_id,
            new_password=reset_password_dto.new_password)
