import typing

from ib_users.constants.otp_verification_constants import SendOTPThrough
from ib_users.exceptions.custom_exception_constants import \
    USER_ACCOUNT_IS_DEACTIVATED
from ib_users.interactors.storages import UserAccountsStorage
from ib_users.interactors.third_party.otp_service import OTPService
from ib_users.utils.interactors.login_interactors_common import \
    are_email_and_phone_number_not_empty
from ib_users.validators import EmailValidator


class SendOTPToUserGivenEmail:
    def __init__(self, storage: UserAccountsStorage, otp_service: OTPService):
        self.storage = storage
        self.otp_service = otp_service

    def send_otp(self, email: str):
        from ib_users.constants.otp_constants import \
            OTPMessageFormatConstants
        EmailValidator.validate(email)
        otp_send_to_dto = self.storage.get_user_details_to_send_otp_given_email(
            email)

        user_account = self.storage.get_user_given_email(email=email)

        self.validate_user_account_for_active_state(
            user_id=user_account.user_id)

        if are_email_and_phone_number_not_empty(otp_send_to_dto):
            self.otp_service.send_otp_to_user_email(
                otp_send_to_dto.email, OTPMessageFormatConstants.FORMAT_TO_LOGIN,
                OTPMessageFormatConstants.OTP_SUBJECT_TO_LOGIN)
            template = self._get_message_template_to_format_to_login(
                country_code=otp_send_to_dto.phone_number.country_code)
            self.otp_service.send_otp_to_user_phone_number(
                phone_number=otp_send_to_dto.phone_number,
                template=template, send_otp_through=SendOTPThrough.SMS,
                call_template=None)
        else:
            self.otp_service.send_otp_to_user_email(
                email=otp_send_to_dto.email,
                template=OTPMessageFormatConstants.FORMAT_TO_LOGIN,
                subject=OTPMessageFormatConstants.OTP_SUBJECT_TO_LOGIN)

    def validate_user_account_for_active_state(self, user_id):
        if not self.storage.is_user_account_active(user_id):
            from ib_users.validators.base_validator import CustomException
            raise CustomException.from_exception_message_DTO(
                USER_ACCOUNT_IS_DEACTIVATED
            )

    def _get_message_template_to_format_to_login(self, country_code):
        from django.conf import settings

        from ib_users.constants.otp_constants import OTPMessageFormatConstants
        from ib_users.constants.sms_constants import INDIA_COUNTRY_CODE

        template = OTPMessageFormatConstants.FORMAT_TO_LOGIN
        if country_code != INDIA_COUNTRY_CODE:
            if settings.USE_TWILIO_FOR_INTERNATIONAL_NUMBERS:
                template = self.storage.get_message_template_string(
                    message_template_id=settings.TWILIO_LOGIN_TEMPLATE_ID)

        return template
