import requests

from ib_users.exceptions.social_service_exceptions import InvalidSocialAccessToken
from ib_users.interactors.third_party.facebook_provider import FacebookLibrary, \
    FacebookProfileDTO


class FacebookProvider(FacebookLibrary):

    GRAPH_API_URL = "https://graph.facebook.com/v12.0/me"

    def get_user_data(self, access_token, fields):

        # For detailed picture information
        if 'picture' in fields:
            fields = fields.replace('picture', 'picture.type(large)')

        try:
            response = requests.get(
                self.GRAPH_API_URL,
                params={
                    'access_token': access_token,
                    'fields': fields
                }
            )
            response.raise_for_status()
            return response.json()
        except requests.RequestException:
            raise InvalidSocialAccessToken.get_for_invalid_fb_token_exception()

    def get_facebook_profile(self, access_token: str) -> FacebookProfileDTO:
        user = self.get_user_data(
            access_token, 'id,name,email,gender,birthday,picture'
        )
        picture_data = user.get('picture', {}).get('data', {})
        profile_pic_url = picture_data.get('url')
        return FacebookProfileDTO(
            id=user['id'],
            name=user['name'],
            birthday=user.get('birthday'),
            gender=user.get('gender'),
            link=profile_pic_url
        )
