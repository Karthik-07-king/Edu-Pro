import logging
from ib_users.interactors.third_party.sms_sender import SMSSender
from ib_users.utils.dtos import PhoneNumberDTO
from django.conf import settings


logger = logging.getLogger(__name__)


class TwilioServiceImpl(SMSSender):
    def __init__(self, message_template: str):
        self.message_template = message_template

    def send_reset_password_link(
            self, phone_number_dto: PhoneNumberDTO, link: str,
            dlt_template_id: str):
        self._send_sms(
            country_code=phone_number_dto.country_code,
            phone_number=phone_number_dto.phone_number,
            msg=self.message_template.format(link=link)
        )

    def send_otp(self, country_code: str, phone_number: str, otp: str):
        self._send_sms(
            country_code=country_code,
            phone_number=phone_number,
            msg=self.message_template.format(otp=otp)
        )

    @staticmethod
    def _send_sms(msg: str, country_code: str, phone_number: str) -> str:
        from twilio.rest import Client

        account_sid = settings.TWILIO_ACCOUNT_SID
        auth_token = settings.TWILIO_AUTH_TOKEN
        client = Client(account_sid, auth_token)

        twilio_virtual_phone_number = settings.TWILIO_VIRTUAL_PHONE_NUMBER
        mobile_number_in_e164_format = country_code + phone_number
        message = client.messages.create(
            from_=twilio_virtual_phone_number,
            to=mobile_number_in_e164_format,
            body=msg)

        return str(message.sid)
