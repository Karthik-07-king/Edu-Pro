import datetime
from typing import List

import typing
from django.db import transaction

from ib_users import models
from ib_users.constants import otp_verification_constants
from ib_users.exceptions.custom_exception_constants import \
    NOT_REGISTERED_USER, INCORRECT_PASSWORD
from ib_users.exceptions.registration_exceptions import \
    AccountWithThisEmailAlreadyExistsException, \
    AccountWithThisPhoneNumberAlreadyExistsException, \
    UsernameAlreadyExistsException
from ib_users.interactors.exceptions.user_credentials_exceptions import \
    AccountWithUsernameDoesntExistException, CurrentPasswordMismatchException, \
    AccountWithEmailDoesntExistException, \
    AccountWithPhoneNumberDoesntExistException, InvalidUserIdException
from ib_users.interactors.registration.DTOs.registration_dtos import \
    CreateAccountWithPhoneNumberDTO, CreateAccountWithEmailDTO
from ib_users.interactors.storages.user_accounts_storage import \
    UserAccountsStorage, PhoneNumberAndPasswordDTO, UserNameAndPasswordDTO, \
    EmailAndPasswordDTO, PhoneNumberDTO, UserEmailAndPhoneNumberDTO, \
    UserAccountDTO, UserIdWithPhoneNumberDTO, UserProfileWithUsernameDTO
from ib_users.models import UserAccount, MessageTemplate
from ib_users.storages.user_account_sql_base_storage import \
    UserAccountSQLBaseStorage
from ib_users.validators.base_validator import CustomException
from ib_users.interactors.storages import dtos as storage_dtos


class UserAccountsSQLStorage(UserAccountSQLBaseStorage, UserAccountsStorage):

    def link_email_to_user(self, user_id: str, email: str):
        try:
            user_account_obj = UserAccount.objects.filter(user_id=user_id). \
                update(email=email)
            return user_account_obj
        except UserAccount.DoesNotExist:
            raise CustomException.from_exception_message_DTO(
                NOT_REGISTERED_USER)

    def link_phone_number_to_user(
            self, user_id: str, phone_number_dto: PhoneNumberDTO):
        try:
            user_account_obj = UserAccount.objects.filter(user_id=user_id). \
                update(phone_number=phone_number_dto.phone_number,
                       country_code=phone_number_dto.country_code)
            return user_account_obj
        except UserAccount.DoesNotExist:
            raise CustomException.from_exception_message_DTO(
                NOT_REGISTERED_USER)

    def get_user_details_to_send_otp_given_phone_number(
            self, phone_number: PhoneNumberDTO) -> UserEmailAndPhoneNumberDTO:
        try:
            user_account_obj = UserAccount.objects.get(
                phone_number=phone_number.phone_number,
                country_code=phone_number.country_code)

            return self._get_user_email_and_phone_number_from_user_account(
                user_account_obj)
        except UserAccount.DoesNotExist:
            raise CustomException.from_exception_message_DTO(
                NOT_REGISTERED_USER)

    def get_user_details_to_send_otp_given_email(
            self, email: str) -> UserEmailAndPhoneNumberDTO:
        try:
            user_account_obj = UserAccount.objects.get(email=email)
            return self._get_user_email_and_phone_number_from_user_account(
                user_account_obj)
        except UserAccount.DoesNotExist:
            raise CustomException.from_exception_message_DTO(
                NOT_REGISTERED_USER)

    def get_user_id_given_phone_number(self, phone_number_dto: PhoneNumberDTO):
        user_account = self. \
            _get_user_account_given_phone_number(phone_number_dto)
        return str(user_account.user_id)

    def get_user_id_given_email(self, email: str):
        user_account = self._get_user_account_given_email(email)
        return str(user_account.user_id)

    def get_user_id_given_username_and_password(
            self, username_login: UserNameAndPasswordDTO):

        user_account = self. \
            _get_user_account_given_username(username_login.username)

        self._check_password_for_given_user_account(
            user_account,
            username_login.password)
        return str(user_account.user_id)

    def get_user_id_given_email_and_password(
            self, email_login: EmailAndPasswordDTO):

        user_account = self. \
            _get_user_account_given_email(email_login.email)

        self._check_password_for_given_user_account(
            user_account,
            email_login.password)
        return str(user_account.user_id)

    def get_user_id_given_phone_number_and_password(
            self, phone_number_login: PhoneNumberAndPasswordDTO):

        user_account = self. \
            _get_user_account_given_phone_number(
            phone_number_login.phone_number_DTO)

        self._check_password_for_given_user_account(
            user_account, phone_number_login.password)

        return str(user_account.user_id)

    def create_account_with_username(self, username: str, password: str) -> \
            str:
        import uuid
        registered_user_account = UserAccount(username=username)
        registered_user_account.user_id = uuid.uuid4()
        registered_user_account.set_password(password)
        registered_user_account.save()
        return str(registered_user_account.user_id)

    def create_account_with_email(
            self, create_account_dto: CreateAccountWithEmailDTO) -> str:
        import uuid
        registered_user_account = UserAccount(email=create_account_dto.email)
        registered_user_account.user_id = uuid.uuid4()

        if create_account_dto.username:
            registered_user_account.username = create_account_dto.username

        registered_user_account.set_password(create_account_dto.password)
        registered_user_account.save()
        return str(registered_user_account.user_id)

    def create_account_with_phone_number(
            self, create_account_dto: CreateAccountWithPhoneNumberDTO) -> str:
        import uuid
        registered_user_account = UserAccount(
            phone_number=create_account_dto.phone_number,
            country_code=create_account_dto.country_code,
            iso_country_code=create_account_dto.iso_country_code
        )
        registered_user_account.user_id = uuid.uuid4()
        if create_account_dto.username:
            registered_user_account.username = create_account_dto.username

        registered_user_account.set_password(create_account_dto.password)
        registered_user_account.save()
        return str(registered_user_account.user_id)

    def check_user_exists_with_username(self, username: str):
        if UserAccount.objects.filter(username=username).exists():
            raise UsernameAlreadyExistsException

    def check_user_exists_with_email(self, email: str):
        if UserAccount.objects.filter(email=email).exists():
            raise AccountWithThisEmailAlreadyExistsException

    def check_user_exists_with_phone_number(
            self, phone_number_dto: PhoneNumberDTO):
        if UserAccount.objects.filter(
                phone_number=phone_number_dto.phone_number,
                country_code=phone_number_dto.country_code).exists():
            raise AccountWithThisPhoneNumberAlreadyExistsException

    def update_username(self, current_username: str, new_username: str):
        updating_user = UserAccount.objects.get(username=current_username)
        updating_user.username = new_username
        updating_user.save()

        return UserAccountDTO(
            user_id=str(updating_user.user_id),
            username=updating_user.username
        )

    def is_username_exists(self, username: str) -> bool:
        return UserAccount.objects.filter(username=username).exists()

    def is_user_account_deactivated(self, user_id: str) -> bool:
        return not self.is_user_account_active(user_id)

    def activate_user(self, user_id: str):
        UserAccount.objects.filter(user_id=user_id).update(is_active=True)

    def deactivate_user_account(self, user_id: str):
        UserAccount.objects.filter(user_id=user_id).update(is_active=False)

    def is_user_id_exists(self, user_id: str) -> bool:
        return UserAccount.objects.filter(user_id=user_id).exists()

    @staticmethod
    def _get_user_email_and_phone_number_from_user_account(
            user_account: UserAccount):

        phone_number_dto = PhoneNumberDTO(user_account.country_code,
                                          user_account.phone_number)
        user_email_and_phone_number_dto = UserEmailAndPhoneNumberDTO(
            str(user_account.user_id),
            user_account.email,
            phone_number_dto)
        return user_email_and_phone_number_dto

    @staticmethod
    def _get_user_account_given_username(username: str):
        try:
            user_account_obj = UserAccount.objects.get(username=username)
            return user_account_obj
        except UserAccount.DoesNotExist:
            raise CustomException.from_exception_message_DTO(
                NOT_REGISTERED_USER)

    @staticmethod
    def _get_user_account_given_email(email: str):
        try:
            user_account_obj = UserAccount.objects.get(email=email)
            return user_account_obj
        except UserAccount.DoesNotExist:
            raise CustomException.from_exception_message_DTO(
                NOT_REGISTERED_USER)

    @staticmethod
    def _get_user_account_given_phone_number(phone_number_dto: PhoneNumberDTO):
        try:
            user_account_obj = UserAccount.objects.get(
                phone_number=phone_number_dto.phone_number,
                country_code=phone_number_dto.country_code)

            return user_account_obj
        except UserAccount.DoesNotExist:
            raise CustomException.from_exception_message_DTO(
                NOT_REGISTERED_USER)

    @staticmethod
    def _check_password_for_given_user_account(user_account: UserAccount,
                                               password):
        is_correct_password = user_account.check_password(password)
        if not is_correct_password:
            raise CustomException.from_exception_message_DTO(
                INCORRECT_PASSWORD)

    def update_user_password(self, user_id: str, new_password: str):
        user_account = UserAccountsSQLStorage._validate_and_get_user_account(
            user_id=user_id)
        user_account.set_password(new_password)
        user_account.is_password_reset = True
        user_account.save()

    def check_current_password_matches(self, user_id: str,
                                       current_password: str):
        user_account = UserAccountsSQLStorage._validate_and_get_user_account(
            user_id=user_id)
        is_match = user_account.check_password(current_password)
        if not is_match:
            raise CurrentPasswordMismatchException

    def is_default_password_changed(self, user_id: str) -> bool:
        user_account = UserAccountsSQLStorage._validate_and_get_user_account(
            user_id)
        return user_account.is_password_reset

    def get_user_given_username(self, username: str) -> UserAccount:
        try:
            user_account = UserAccount.objects.get(username=username)
            return user_account
        except UserAccount.DoesNotExist:
            raise AccountWithUsernameDoesntExistException

    def get_user_given_email(self, email: str) -> UserAccount:
        try:
            user_account = UserAccount.objects.get(email=email)
            return user_account
        except UserAccount.DoesNotExist:
            raise AccountWithEmailDoesntExistException

    def get_existing_user_id_given_email(self, email: str):
        try:
            user_account = UserAccount.objects.get(email=email)
            return str(user_account.user_id)
        except UserAccount.DoesNotExist:
            raise AccountWithEmailDoesntExistException

    def get_user_given_phone_number(
            self, phone_number_dto: PhoneNumberDTO) -> UserAccount:
        try:
            user_account = UserAccount.objects.get(
                phone_number=phone_number_dto.phone_number,
                country_code=phone_number_dto.country_code)
            return user_account
        except UserAccount.DoesNotExist:
            raise AccountWithPhoneNumberDoesntExistException

    def get_user_details_to_send_otp_given_username(self,
                                                    username: str) -> UserEmailAndPhoneNumberDTO:
        try:
            user_account = UserAccount.objects.get(username=username)
            user_contact_details = UserEmailAndPhoneNumberDTO(
                user_id=user_account.user_id,
                phone_number=PhoneNumberDTO(user_account.phone_number,
                                            user_account.country_code),
                email=user_account.email)
            return user_contact_details
        except UserAccount.DoesNotExist:
            raise AccountWithUsernameDoesntExistException

    @staticmethod
    def _validate_and_get_user_account(user_id: str) -> UserAccount:
        try:
            return UserAccount.objects.get(user_id=user_id)
        except UserAccount.DoesNotExist:
            raise InvalidUserIdException

    def get_user_email(self, user_id) -> str:
        ua = UserAccount.objects.get(user_id=user_id)
        return ua.email

    def get_user_phone_number(self, user_id) -> str:
        ua = UserAccount.objects.get(user_id=user_id)
        return ua.phone_number

    def get_user_account_details(self, user_id: str) -> UserAccountDTO:
        ua = UserAccount.objects.get(user_id=user_id)
        return UserAccountDTO(username=ua.username,
                              phone_number=ua.phone_number,
                              email=ua.email,
                              country_code=ua.country_code,
                              user_id=ua.user_id)

    def update_user_phone_number(self, user_id, phone_number, country_code):
        ua = UserAccount.objects.get(user_id=user_id)
        ua.phone_number = phone_number
        ua.country_code = country_code
        ua.save()

    def update_email(self, user_id, email):
        ua = UserAccount.objects.get(user_id=user_id)
        ua.email = email
        ua.save()

    def update_user_active_status(self, user_id: str, is_active: bool):
        UserAccount.objects.filter(user_id=user_id).update(
            is_active=is_active
        )

    @transaction.atomic
    def set_user_last_login(self, user_id: str):
        from ib_common.date_time_utils.get_current_local_date_time import \
            get_current_local_date_time
        UserAccount.objects.filter(user_id=user_id).update(
            last_login=get_current_local_date_time()
        )

    def get_all_users_accounts(self) -> List[UserAccountDTO]:
        pass
        user_account_objs = UserAccount.objects.all()
        users_accounts_dtos = [
            UserAccountDTO(
                user_id=user_account_obj.user_id,
                username=user_account_obj.username,
                email=user_account_obj.email,
                phone_number=user_account_obj.phone_number,
                country_code=user_account_obj.country_code
            )
            for user_account_obj in user_account_objs
        ]
        return users_accounts_dtos

    def check_is_user_ids_already_exists(self, user_ids: List[str]):
        user_account_objs = UserAccount.objects.filter(user_id__in=user_ids)
        if user_account_objs:
            user_ids = []
            for user_account_obj in user_account_objs:
                user_ids.append(user_account_obj.user_id)
            from ib_users.exceptions.user_account_exceptions import \
                UserIdsAlreadyExistsException
            raise UserIdsAlreadyExistsException(user_ids)

    def get_user_id_give_username(self, username: str):
        user_account = self.get_user_given_username(username=username)
        return str(user_account.user_id)

    def get_user_ids_for_given_phone_numbers(
            self, phone_number_with_country_code_dtos: typing.List[
                PhoneNumberDTO]) -> typing.List[UserIdWithPhoneNumberDTO]:
        from django.db.models import Q

        query = Q()
        for phone_number_with_country_code_dto in phone_number_with_country_code_dtos:
            query |= Q(phone_number=phone_number_with_country_code_dto.phone_number,
                       country_code=phone_number_with_country_code_dto.country_code)

        user_account_objs = UserAccount.objects.filter(query)
        return [
            UserIdWithPhoneNumberDTO(
                user_id=str(user_account_obj.user_id),
                phone_number=user_account_obj.phone_number,
                country_code=user_account_obj.country_code)
            for user_account_obj in user_account_objs
        ]
    
    def get_message_template_string(self, message_template_id: str) -> str:
        from ib_users.exceptions.user_account_exceptions import \
            MessageTemplateDoesNotExistsException
        
        try:
            message_template = MessageTemplate.objects.get(id=message_template_id)
        except MessageTemplate.DoesNotExist:
            raise MessageTemplateDoesNotExistsException()
        
        return message_template.template_string

    def get_user_latest_update_phone_number_log_details(self, user_id: str) \
            -> typing.Optional[
                storage_dtos.UserAccountUpdatePhoneLogWithCreationDetailsDTO]:

        user_account_phone_number_log = models\
            .UpdateUserAccountPhoneNumberLog.objects.\
            filter(user_account_id=user_id).\
            order_by('-creation_datetime').first()

        if not user_account_phone_number_log:
            return

        return storage_dtos.UserAccountUpdatePhoneLogWithCreationDetailsDTO(
            id=str(user_account_phone_number_log.id),
            user_id=str(user_account_phone_number_log.user_account_id),
            old_phone_number=user_account_phone_number_log.old_phone_number,
            old_country_code=user_account_phone_number_log.old_country_code,
            new_phone_number=user_account_phone_number_log.new_phone_number,
            new_country_code=user_account_phone_number_log.new_country_code,
            change_reason=user_account_phone_number_log.change_reason,
            verification_status=
            user_account_phone_number_log.verification_status,
            failure_remarks=user_account_phone_number_log.failure_remarks,
            creation_datetime=user_account_phone_number_log.creation_datetime,
            last_update_datetime=
            user_account_phone_number_log.last_update_datetime,
            verified_datetime=user_account_phone_number_log.verified_datetime
        )

    def create_user_account_phone_number_update_log_details(
            self, user_account_update_phone_details_dto:
            storage_dtos.UserAccountUpdatePhoneDetailsLogDTO):

        models.UpdateUserAccountPhoneNumberLog.objects.create(
            user_account_id=user_account_update_phone_details_dto.user_id,
            old_phone_number=
            user_account_update_phone_details_dto.old_phone_number,
            old_country_code=
            user_account_update_phone_details_dto.old_country_code,
            new_phone_number=
            user_account_update_phone_details_dto.new_phone_number,
            new_country_code=
            user_account_update_phone_details_dto.new_country_code,
            change_reason=
            user_account_update_phone_details_dto.change_reason,
            verification_status=
            user_account_update_phone_details_dto.verification_status,
            failure_remarks=
            user_account_update_phone_details_dto.failure_remarks,
            verified_datetime=user_account_update_phone_details_dto.verified_datetime)

    def update_user_update_phone_number_verification_status(
            self, user_account_update_phone_details_log_id: int,
            verification_status: otp_verification_constants.VerificationStatus,
            failure_remarks: typing.Optional[str],
            verified_datetime: typing.Optional[datetime.datetime]):
        models.UpdateUserAccountPhoneNumberLog.objects.filter(
            id=user_account_update_phone_details_log_id).update(
            verification_status=verification_status,
            failure_remarks=failure_remarks,
            verified_datetime=verified_datetime)

    def get_users_phone_number_update_logs(
            self, user_ids: typing.List[str],
            verification_status: otp_verification_constants.VerificationStatus
            ) -> typing.List[storage_dtos.UserAccountUpdatePhoneDetailsLogDTO]:
        update_phone_number_log_objs = models.UpdateUserAccountPhoneNumberLog.objects.filter(
            user_account_id__in=user_ids,
            verification_status=verification_status)

        return [
            storage_dtos.UserAccountUpdatePhoneDetailsLogDTO(
                user_id=str(update_phone_number_log_obj.user_account_id),
                old_phone_number=update_phone_number_log_obj.old_phone_number,
                old_country_code=update_phone_number_log_obj.old_country_code,
                new_phone_number=update_phone_number_log_obj.new_phone_number,
                new_country_code=update_phone_number_log_obj.new_country_code,
                change_reason=update_phone_number_log_obj.change_reason,
                verification_status=update_phone_number_log_obj.verification_status,
                failure_remarks=update_phone_number_log_obj.failure_remarks,
                verified_datetime=update_phone_number_log_obj.verified_datetime
            )
            for update_phone_number_log_obj in update_phone_number_log_objs
        ]

    def get_users_accounts_details_to_update(self, user_ids: typing.List[str]) -> typing.List[UserAccountDTO]:
        user_account_objs = UserAccount.objects.select_for_update().filter(
            user_id__in=user_ids)
        users_accounts_dtos = [
            UserAccountDTO(
                user_id=str(user_account_obj.user_id),
                username=user_account_obj.username,
                email=user_account_obj.email,
                phone_number=user_account_obj.phone_number,
                country_code=user_account_obj.country_code
            )
            for user_account_obj in user_account_objs
        ]
        return users_accounts_dtos
