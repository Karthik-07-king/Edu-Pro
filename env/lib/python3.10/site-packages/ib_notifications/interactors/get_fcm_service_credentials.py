import json
from typing import Tuple, Dict

from ib_notifications.constants.enums import FCMKeysSource
from ib_notifications.interactors.storages.storage_interface import \
    StorageInterface
from django.conf import settings


class GetFCMServiceCredentialsInteractor:

    def __init__(self, storage: StorageInterface):
        self.storage = storage

    def get_fcm_service_credentials(self) -> Tuple[Dict[str, str], str]:

        fcm_keys_from = settings.FETCH_FCM_KEYS_FROM
        if not fcm_keys_from:
            fcm_keys_from = FCMKeysSource.FROM_FILE.value


        if fcm_keys_from == FCMKeysSource.RDS.value:
            fcm_credentials = self.storage.get_fcm_credentials_json()
            if not fcm_credentials:
                raise NotImplementedError("Creds not found in RDS")
            credentials = fcm_credentials
            project_id = fcm_credentials["project_id"]
        elif fcm_keys_from == FCMKeysSource.FROM_FILE.value:
            with open(settings.FCM_CREDENTIALS_FILE_PATH, 'r') as file:
                credentials = json.load(file)
                project_id = settings.FCM_PROJECT_NAME
        else:
            raise NotImplementedError()

        return credentials, project_id

