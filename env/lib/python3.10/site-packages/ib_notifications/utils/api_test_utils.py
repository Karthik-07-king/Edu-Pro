import datetime

from django_swagger_utils.utils.test import CustomAPITestCase
from freezegun import freeze_time
from ib_notifications.storages.storage_implementation import \
    StorageImplementation

from ib_notifications.models import Notification, UserNotification


class ApiTestUtils(CustomAPITestCase):
    NOTIFICATION_DATA = []
    USER_DEVICE_TOKEN = {}

    @freeze_time("2019-11-12 12:00:00")
    def create_user_notifications(self):
        notifications = self.create_notifications()
        for notification in notifications:
            UserNotification.objects.create(
                user_id=str(self.foo_user.id),
                notification_id=notification.id,
                read_at=datetime.datetime.now()
            )

    def create_notifications(self):
        return [
            Notification.objects.create(
                id=notification_data["id"],
                title=notification_data["title"],
                message=notification_data["message"],
                notification_type=notification_data["notification_type"],
                extra_data=notification_data["extra_data"]
            )
            for notification_data in self.NOTIFICATION_DATA
        ]

    def create_user_unread_notifications(self):
        notifications = self.create_notifications()
        for notification in notifications:
            UserNotification.objects.create(
                user_id=str(self.foo_user.id),
                notification_id=notification.id,
            )

    def create_user_device_token(self):
        storage = StorageImplementation()
        storage.create_cloud_message_token(
            user_id=str(self.foo_user.id),
            device_id=self.USER_DEVICE_TOKEN["device_id"],
            device_type=self.USER_DEVICE_TOKEN["device_type"],
            token=self.USER_DEVICE_TOKEN["token"]
        )
