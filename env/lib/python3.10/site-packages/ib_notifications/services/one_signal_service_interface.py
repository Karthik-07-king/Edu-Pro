import json
from typing import List, Dict

import requests
from django.conf import settings

from ib_notifications.dtos.cm_token_with_user_id_dto import UserIdWithCMToken
from ib_notifications.dtos.notification_message_dto import \
    NotificationMessageDTO
from ib_notifications.services.cloud_messaging_interface import \
    CloudMessagingInterface


class OneSignalServiceInterface(CloudMessagingInterface):

    def __init__(self, *args, **kwargs):
        try:
            auth_token = settings.ONE_SIGNAL_AUTH_TOKEN
            app_id = settings.ONE_SIGNAL_APP_ID
        except AttributeError:
            raise NotImplementedError()

        if not auth_token or not app_id:
            raise NotImplementedError()

        self.auth_token = auth_token
        self.app_id = app_id

    def send_notification(
            self, cm_token_dtos: List[UserIdWithCMToken],
            notification_message_dto: NotificationMessageDTO):
        registration_ids = [dto.cm_token for dto in cm_token_dtos]
        notification_request_data = self._get_request_data(
            notification_message_dto=notification_message_dto,
            registration_ids=registration_ids
        )

        header = {"Content-Type": "application/json; charset=utf-8"}
        one_signal_response = \
            requests.post(
                "https://onesignal.com/api/v1/notifications",
                headers=header, data=json.dumps(notification_request_data))

        response_dict = json.loads(one_signal_response.content)
        return response_dict

    def _get_request_data(
            self, notification_message_dto: NotificationMessageDTO,
            registration_ids: List[str]) -> Dict:

        notification_request_data = {
            "app_id": self.app_id,
            "include_player_ids": registration_ids,
            'headings': {"en": notification_message_dto.title},
            'contents': {"en": notification_message_dto.message},
        }
        if notification_message_dto.extra_data:
            data = json.loads(notification_message_dto.extra_data)
            data["notification_id"] = notification_message_dto.notification_id
            notification_request_data["data"] = data
        if notification_message_dto.url:
            notification_request_data["url"] = notification_message_dto.url

        return notification_request_data
